final version: filtered and balanced